name: Build & Publish AmneziaWG Packages

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      gl_version:
        description: 'GL.iNet version AmneziaWG'
        required: false
        type: string
      force_rebuild:
        description: 'Force rebuild even if packages exist'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

env:
  owr_branch: "openwrt-24.10"
  owr_commit: "b546f80a3f"
  gl_version: ${{ inputs.gl_version || '4.7.5' }}
  gl_vermagic: "f2c63d42896f12da2b55f2c2b626e7be"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout Configs
        uses: actions/checkout@v4
        with:
          path: gl

      - name: Checkout AmneziaWG Source
        uses: actions/checkout@v4
        with:
          path: awg
          repository: amnezia-vpn/amneziawg-openwrt

      - name: Checkout OpenWRT
        uses: actions/checkout@v4
        with:
          path: owrt
          repository: openwrt/openwrt
          ref: ${{ env.owr_branch }}
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev gawk git subversion \
            libssl-dev gettext zlib1g-dev swig unzip time rsync python3 python3-setuptools \
            python3-yaml

      - name: Validate Configuration File
        run: |
          CONFIG_FILE="gl/config_${{ env.gl_version }}.buildinfo"
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "âŒ Missing configuration: $CONFIG_FILE"
            echo "Available configs:"
            ls -la gl/config_*.buildinfo || echo "No config files found"
            exit 1
          fi
          echo "âœ… Using $CONFIG_FILE"

      - name: Apply AmneziaWG Debug Fix Patch
        run: |
          cd awg
          echo "ðŸ” Exploring AmneziaWG project structure..."
          find . -name "*.h" -o -name "*.c" | head -20
          
          # Ð˜Ñ‰ÐµÐ¼ Ð²ÑÐµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ Ð¿Ð°Ñ‚Ñ‡Ð¸Ð½Ð³Ð°
          COMPAT_FILES=$(find . -name "compat.h" -o -name "compat-*.h" 2>/dev/null || true)
          SOURCE_FILES=$(find . -name "*.c" -exec grep -l "pr_debug\|printk" {} \; 2>/dev/null | head -10 || true)
          
          echo "Found compat files: $COMPAT_FILES"
          echo "Found source files with debug calls: $SOURCE_FILES"
          
          # Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ñ„Ð¸ÐºÑÐ° Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸
          apply_debug_fix() {
            local file="$1"
            echo "ðŸ”§ Applying debug fix to: $file"
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿
            cp "$file" "$file.bak"
            
            # ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ Ñ„Ð¸ÐºÑ Ð² Ð½Ð°Ñ‡Ð°Ð»Ð¾ Ñ„Ð°Ð¹Ð»Ð°
            cat > "$file.tmp" <<'EOF'
          /* AmneziaWG Debug Fix for OpenWRT 24.10 */
          #ifndef _AWG_DEBUG_FIX_APPLIED
          #define _AWG_DEBUG_FIX_APPLIED
          
          #include <linux/printk.h>
          
          /* Replace dynamic debug with no-op for compatibility */
          #ifdef pr_debug
          #undef pr_debug
          #endif
          #define pr_debug(fmt, ...) no_printk(KERN_DEBUG fmt, ##__VA_ARGS__)
          
          #ifdef dynamic_pr_debug
          #undef dynamic_pr_debug
          #endif
          #define dynamic_pr_debug(fmt, ...) no_printk(KERN_DEBUG fmt, ##__VA_ARGS__)
          
          #endif /* _AWG_DEBUG_FIX_APPLIED */
          
          EOF
            cat "$file" >> "$file.tmp"
            mv "$file.tmp" "$file"
            echo "âœ… Applied debug fix to: $file"
          }
          
          # ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ Ñ„Ð¸ÐºÑ Ðº Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ð¼ compat Ñ„Ð°Ð¹Ð»Ð°Ð¼
          if [ -n "$COMPAT_FILES" ]; then
            for file in $COMPAT_FILES; do
              apply_debug_fix "$file"
            done
          else
            echo "âš ï¸ No compat.h found, looking for main source files..."
            
            # Ð˜Ñ‰ÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
            MAIN_FILES=$(find . -name "*.h" -path "*/src/*" -o -name "*.h" -path "*/kernel/*" 2>/dev/null | head -5)
            if [ -n "$MAIN_FILES" ]; then
              for file in $MAIN_FILES; do
                if grep -q "linux/.*\.h\|#include" "$file" 2>/dev/null; then
                  apply_debug_fix "$file"
                  break
                fi
              done
            fi
          fi
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ñ‡Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ñ„Ð¸ÐºÑÐ°
          echo "ðŸ“ Creating universal debug fix header..."
          mkdir -p src/compat kernel/compat
          
          cat > debug-compat.h <<'EOF'
          #ifndef _AMNEZIAWG_DEBUG_COMPAT_H
          #define _AMNEZIAWG_DEBUG_COMPAT_H
          
          #include <linux/kernel.h>
          #include <linux/printk.h>
          
          /* OpenWRT 24.10 Compatibility Layer */
          #ifdef CONFIG_DYNAMIC_DEBUG
          /* If dynamic debug is enabled, try to use it safely */
          #ifndef KBUILD_MODNAME
          #define KBUILD_MODNAME "amneziawg"
          #endif
          
          #ifdef pr_debug
          #undef pr_debug
          #endif
          #define pr_debug(fmt, ...) \
              do { \
                  if (0) \
                      printk(KERN_DEBUG pr_fmt(fmt), ##__VA_ARGS__); \
              } while (0)
          
          #else
          /* Fallback for systems without dynamic debug */
          #ifdef pr_debug
          #undef pr_debug
          #endif
          #define pr_debug(fmt, ...) no_printk(KERN_DEBUG fmt, ##__VA_ARGS__)
          #endif
          
          /* Additional symbol compatibility */
          #ifndef __dynamic_pr_debug
          #define __dynamic_pr_debug(fmt, ...) no_printk(fmt, ##__VA_ARGS__)
          #endif
          
          #endif /* _AMNEZIAWG_DEBUG_COMPAT_H */
          EOF
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð² Ñ€Ð°Ð·Ð½Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð¼ÐµÑÑ‚Ð°
          cp debug-compat.h src/compat/ 2>/dev/null || true
          cp debug-compat.h kernel/compat/ 2>/dev/null || true
          cp debug-compat.h . 2>/dev/null || true
          
          echo "âœ… Debug compatibility layer created"
          
          # ÐœÐ¾Ð´Ð¸Ñ„Ð¸Ñ†Ð¸Ñ€ÑƒÐµÐ¼ Makefile Ð´Ð»Ñ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð½Ð°ÑˆÐµÐ³Ð¾ Ñ„Ð¸ÐºÑÐ°
          for makefile in $(find . -name "Makefile" -o -name "*.mk" | head -5); do
            if grep -q "EXTRA_CFLAGS\|ccflags" "$makefile" 2>/dev/null; then
              echo "ðŸ”§ Patching Makefile: $makefile"
              sed -i.bak '/EXTRA_CFLAGS\|ccflags/a\\nEXTRA_CFLAGS += -include $(src)/debug-compat.h -Dpr_debug=no_printk' "$makefile" || true
            fi
          done
          
          echo "âœ… AmneziaWG debug compatibility patches applied"

      - name: Prepare OpenWRT Build
        run: |
          cd owrt
          git reset --hard ${{ env.owr_commit }}
          mkdir -p package/awg
          cp -a ../awg/. package/awg/

          ./scripts/feeds update -a
          ./scripts/feeds install -a

          cp ../gl/config_${{ env.gl_version }}.buildinfo .config

          # Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ð°Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼ Ñ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°Ð¼Ð¸ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸
          cat >> .config <<EOF
          CONFIG_PACKAGE_kmod-amneziawg=m
          CONFIG_PACKAGE_amneziawg-tools=y
          CONFIG_PACKAGE_luci-proto-amneziawg=y
          CONFIG_PACKAGE_kmod-crypto-lib-chacha20=m
          CONFIG_PACKAGE_kmod-crypto-lib-chacha20poly1305=m
          CONFIG_PACKAGE_kmod-crypto-chacha20poly1305=m
          
          # Kernel debug configuration for symbol compatibility
          CONFIG_PRINTK=y
          CONFIG_PRINTK_TIME=y
          CONFIG_DYNAMIC_DEBUG=y
          CONFIG_SYMBOLIC_ERRNAME=y
          CONFIG_DEBUG_KERNEL=y
          CONFIG_DEBUG_INFO=y
          CONFIG_DEBUG_INFO_REDUCED=n
          CONFIG_DEBUG_INFO_SPLIT=n
          CONFIG_DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT=y
          
          # Ensure all required kernel symbols are exported
          CONFIG_KALLSYMS=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_MODVERSIONS=y
          CONFIG_MODULE_SRCVERSION_ALL=y
          EOF

          make defconfig

          # Override vermagic
          sed -i.bak '/\.vermagic/c\	echo "${{ env.gl_vermagic }}" > $(LINUX_DIR)/.vermagic' ./include/kernel-defaults.mk

      - name: Build Kernel and Toolchain
        run: |
          cd owrt
          make tools/install -j$(nproc)
          make toolchain/install -j$(nproc)
          make target/linux/{clean,compile} -i -j$(nproc) V=s

      - name: Verify Kernel Symbols
        run: |
          cd owrt
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸ Ð² ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¼ ÑÐ´Ñ€Ðµ
          KERNEL_BUILD_DIR=$(find build_dir/target-*/linux-*/linux-* -name "Module.symvers" | head -1 | xargs dirname)
          if [ -f "$KERNEL_BUILD_DIR/Module.symvers" ]; then
            echo "ðŸ” Checking for debug symbols in kernel..."
            if grep -q "__dynamic_pr_debug\|printk\|no_printk" "$KERNEL_BUILD_DIR/Module.symvers"; then
              echo "âœ… Debug symbols found in kernel"
            else
              echo "âš ï¸ Debug symbols not found, but continuing..."
            fi
          fi

      - name: Build AmneziaWG Packages
        run: |
          cd owrt
          success=0
          total=0
          
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸
          export EXTRA_CFLAGS="-DCONFIG_DYNAMIC_DEBUG_CORE=1"
          
          for pkg in package/awg/*/; do
            [ -f "$pkg/Makefile" ] || continue
            pkgname=$(basename "$pkg")
            echo "ðŸ”§ Building: $pkgname"
            
            # Ð‘Ð¾Ð»ÐµÐµ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ ÑÐ±Ð¾Ñ€ÐºÐ° Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¾Ð¹ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
            make package/awg/${pkgname}/clean V=s || true
            make package/awg/${pkgname}/download V=s || true
            make package/awg/${pkgname}/prepare V=s || true
            
            # ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸ Ñ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ð¾Ð¹ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¾Ð¹
            if make package/awg/${pkgname}/compile V=s 2>&1 | tee /tmp/build_${pkgname}.log; then
              success=$((success+1))
              echo "âœ… Successfully built: $pkgname"
            else
              echo "âŒ Failed to build: $pkgname"
              echo "Build log:"
              tail -50 /tmp/build_${pkgname}.log
              
              # ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð±ÐµÐ· Ð¾Ñ‚Ð»Ð°Ð´Ð¾Ñ‡Ð½Ñ‹Ñ… ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²
              echo "ðŸ”„ Retrying without debug symbols..."
              export EXTRA_CFLAGS="-Dpr_debug=no_printk"
              if make package/awg/${pkgname}/compile V=s; then
                success=$((success+1))
                echo "âœ… Built with debug workaround: $pkgname"
              fi
            fi
            total=$((total+1))
          done
          
          echo "âœ… $success/$total packages built."
          [ "$success" -gt 0 ] || exit 1

      - name: Collect Built Packages
        run: |
          cd owrt
          mkdir -p ../artifacts
          packages_found=0
          
          for pattern in kmod-amneziawg amneziawg-tools luci-proto-amneziawg; do
            files=$(find bin/ -name "${pattern}*.ipk" 2>/dev/null || true)
            if [ -n "$files" ]; then
              echo "$files" | while read -r file; do
                [ -f "$file" ] || continue
                cp "$file" ../artifacts/
                echo "âœ… Copied: $(basename "$file")"
              done
              packages_found=$((packages_found + 1))
            else
              echo "âš ï¸ Pattern $pattern not found"
            fi
          done
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ñ Ð±Ñ‹ Ð¾Ð´Ð¸Ð½ Ñ„Ð°Ð¹Ð» ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½
          actual_files=$(ls -1 ../artifacts/*.ipk 2>/dev/null | wc -l)
          if [ "$actual_files" -eq 0 ]; then
            echo "âŒ No packages found to collect"
            echo "Available files in bin/:"
            find bin/ -name "*.ipk" -ls || echo "No .ipk files found"
            exit 1
          fi
          echo "âœ… Collected $actual_files package(s)"

      - name: Test Package Installation (Dry Run)
        run: |
          cd artifacts
          echo "ðŸ§ª Testing packages for common issues..."
          for pkg in *.ipk; do
            [ -f "$pkg" ] || continue
            echo "Testing: $pkg"
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¿Ð°ÐºÐµÑ‚Ð°
            if command -v ar >/dev/null 2>&1; then
              ar t "$pkg" 2>/dev/null || echo "âš ï¸ Package structure issue: $pkg"
            fi
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð¿Ð°ÐºÐµÑ‚Ð°
            size=$(stat -c%s "$pkg" 2>/dev/null || echo "0")
            if [ "$size" -lt 1000 ]; then
              echo "âš ï¸ Suspiciously small package: $pkg ($size bytes)"
            else
              echo "âœ… Package size OK: $pkg ($size bytes)"
            fi
          done

      - name: Extract kernel info
        id: kinfo
        run: |
          cd owrt
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð°
          VERMAGIC_FILE=""
          for i in {1..30}; do
            VERMAGIC_FILE=$(find build_dir/target-*/linux-*/linux-*/.vermagic 2>/dev/null | head -n1)
            [ -n "$VERMAGIC_FILE" ] && [ -f "$VERMAGIC_FILE" ] && break
            echo "Waiting for .vermagic file... ($i/30)"
            sleep 2
          done
          
          if [ ! -f "$VERMAGIC_FILE" ]; then
            echo "âŒ .vermagic not found after 60s timeout"
            echo "Searching for .vermagic files:"
            find build_dir/ -name ".vermagic" -ls 2>/dev/null || echo "No .vermagic files found"
            exit 1
          fi

          # Ð¡Ñ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ VERMAGIC
          VERMAGIC_CONTENT=$(cat "$VERMAGIC_FILE")
          echo "vermagic=$VERMAGIC_CONTENT" >> "$GITHUB_OUTPUT"

          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ ÑÐ´Ñ€Ð° Ñ‡ÐµÑ€ÐµÐ· make kernelversion
          KERNEL_DIR=$(dirname "$VERMAGIC_FILE")
          if [ -d "$KERNEL_DIR" ]; then
            KERNEL_VERSION=$(make -s -C "$KERNEL_DIR" kernelversion 2>/dev/null || echo "unknown")
          else
            KERNEL_VERSION="unknown"
          fi
          echo "kernel_version=$KERNEL_VERSION" >> "$GITHUB_OUTPUT"
          
          echo "âœ… Kernel: $KERNEL_VERSION, VERMAGIC: $VERMAGIC_CONTENT"

      - name: Create release notes
        run: |
          cat > release_notes.md <<EOF
          # AmneziaWG GL.iNet v${{ env.gl_version }}
          
          Built from OpenWRT ${{ env.owr_branch }} (commit: ${{ env.owr_commit }})
          
          ## Kernel Information
          â€¢ **Version**: ${{ steps.kinfo.outputs.kernel_version }}
          â€¢ **VERMAGIC**: ${{ steps.kinfo.outputs.vermagic }}
          
          ## Fixes Applied
          â€¢ Fixed \`__dynamic_pr_debug\` symbol compatibility issue for OpenWRT 24.10
          â€¢ Enhanced kernel debug configuration
          â€¢ Added fallback compilation without debug symbols
          
          ## Package Contents
          EOF
          
          if [ -d artifacts ] && [ "$(ls -A artifacts/ 2>/dev/null)" ]; then
            for f in artifacts/*.ipk; do
              [ -f "$f" ] || continue
              name=$(basename "$f")
              size=$(stat -c%s "$f" 2>/dev/null || echo "unknown")
              echo "â€¢ \`$name\` ($size bytes)" >> release_notes.md
            done
          else
            echo "âš ï¸ No packages found in artifacts/" >> release_notes.md
          fi
          
          cat >> release_notes.md <<EOF
          
          ## Installation Notes
          If you encounter \`Unknown symbol\` errors during installation:
          1. Ensure your kernel has \`CONFIG_DYNAMIC_DEBUG=y\`
          2. Try \`opkg install --force-depends\` if dependencies are missing
          3. Check kernel version compatibility with \`uname -r\`
          EOF
          
          echo ""
          echo "Generated release notes:"
          cat release_notes.md

      - name: Upload Packages as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: amneziawg-packages-${{ env.gl_version }}
          path: artifacts/*.ipk

      - name: Auto-Publish Release
        if: startsWith(github.ref, 'refs/tags/') && hashFiles('artifacts/*.ipk') != ''
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.ipk
          body_path: release_notes.md
          fail_on_unmatched_files: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

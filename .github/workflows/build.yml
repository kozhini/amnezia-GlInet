name: Build & Publish AmneziaWG Packages

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      gl_version:
        description: 'GL.iNet version override'
        required: false
        type: string
      force_rebuild:
        description: 'Force rebuild even if packages exist'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

env:
  owr_branch: "openwrt-24.10"
  owr_commit: "b546f80a3f"
  gl_version: ${{ inputs.gl_version || '4.7.5' }}
  gl_vermagic: "9469a6c8c449c47e503c05678ea1559d"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout Configs
        uses: actions/checkout@v4
        with:
          path: gl

      - name: Checkout AmneziaWG Source
        uses: actions/checkout@v4
        with:
          path: awg
          repository: amnezia-vpn/amneziawg-openwrt

      - name: Checkout OpenWRT
        uses: actions/checkout@v4
        with:
          path: owrt
          repository: openwrt/openwrt
          ref: ${{ env.owr_branch }}
          fetch-depth: 0

      # ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      - name: Cache APT packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: apt-cache-${{ runner.os }}-${{ hashFiles('**/apt-requirements.txt') }}
          restore-keys: |
            apt-cache-${{ runner.os }}-

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev gawk git subversion \
            libssl-dev gettext zlib1g-dev swig unzip time rsync python3 python3-setuptools \
            python3-yaml

      # ÐœÐ½Ð¾Ð³Ð¾ÑƒÑ€Ð¾Ð²Ð½ÐµÐ²Ð¾Ðµ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ OpenWRT
      - name: Cache OpenWRT downloads
        uses: actions/cache@v4
        with:
          path: owrt/dl
          key: openwrt-dl-${{ env.owr_branch }}-${{ env.owr_commit }}-${{ hashFiles('owrt/feeds.conf.default') }}
          restore-keys: |
            openwrt-dl-${{ env.owr_branch }}-${{ env.owr_commit }}-
            openwrt-dl-${{ env.owr_branch }}-
            openwrt-dl-

      - name: Cache OpenWRT feeds
        uses: actions/cache@v4
        with:
          path: |
            owrt/feeds
            owrt/package/feeds
          key: openwrt-feeds-${{ env.owr_branch }}-${{ env.owr_commit }}-${{ hashFiles('owrt/feeds.conf.default') }}
          restore-keys: |
            openwrt-feeds-${{ env.owr_branch }}-${{ env.owr_commit }}-
            openwrt-feeds-${{ env.owr_branch }}-

      - name: Cache OpenWRT staging
        uses: actions/cache@v4
        with:
          path: owrt/staging_dir
          key: openwrt-staging-${{ env.owr_branch }}-${{ env.owr_commit }}-${{ env.gl_version }}-${{ hashFiles('gl/config_*.buildinfo') }}
          restore-keys: |
            openwrt-staging-${{ env.owr_branch }}-${{ env.owr_commit }}-${{ env.gl_version }}-
            openwrt-staging-${{ env.owr_branch }}-${{ env.owr_commit }}-
            openwrt-staging-${{ env.owr_branch }}-

      - name: Cache OpenWRT toolchain
        uses: actions/cache@v4
        with:
          path: |
            owrt/build_dir/toolchain-*
            owrt/build_dir/host
          key: openwrt-toolchain-${{ env.owr_branch }}-${{ env.owr_commit }}-${{ env.gl_version }}-${{ hashFiles('gl/config_*.buildinfo') }}
          restore-keys: |
            openwrt-toolchain-${{ env.owr_branch }}-${{ env.owr_commit }}-${{ env.gl_version }}-
            openwrt-toolchain-${{ env.owr_branch }}-${{ env.owr_commit }}-
            openwrt-toolchain-${{ env.owr_branch }}-

      # ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ñ… Ñ†ÐµÐ»ÐµÐ¹
      - name: Cache OpenWRT build artifacts
        uses: actions/cache@v4
        with:
          path: |
            owrt/build_dir/target-*
            owrt/tmp
          key: openwrt-build-${{ env.owr_branch }}-${{ env.owr_commit }}-${{ env.gl_version }}-${{ env.gl_vermagic }}-${{ hashFiles('gl/config_*.buildinfo', 'awg/**') }}
          restore-keys: |
            openwrt-build-${{ env.owr_branch }}-${{ env.owr_commit }}-${{ env.gl_version }}-${{ env.gl_vermagic }}-
            openwrt-build-${{ env.owr_branch }}-${{ env.owr_commit }}-${{ env.gl_version }}-
            openwrt-build-${{ env.owr_branch }}-${{ env.owr_commit }}-

      - name: Validate Configuration File
        run: |
          CONFIG_FILE="gl/config_${{ env.gl_version }}.buildinfo"
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "âŒ Missing configuration: $CONFIG_FILE"
            echo "Available configs:"
            ls -la gl/config_*.buildinfo || echo "No config files found"
            exit 1
          fi
          echo "âœ… Using $CONFIG_FILE"

      - name: Prepare OpenWRT Build
        run: |
          cd owrt
          git reset --hard ${{ env.owr_commit }}
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚
          mkdir -p dl package/awg feeds staging_dir build_dir tmp
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ÑÑ…Ð¾Ð´Ð½Ð¸ÐºÐ¸ AmneziaWG
          cp -a ../awg/. package/awg/

          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ feeds Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÐºÑÑˆ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½
          if [ ! -d "feeds/packages" ] || [ ! -d "feeds/luci" ]; then
            echo "ðŸ”„ Updating feeds (cache miss)"
            ./scripts/feeds update -a
            ./scripts/feeds install -a
          else
            echo "âœ… Using cached feeds"
            ./scripts/feeds install -a
          fi

          # ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
          cp ../gl/config_${{ env.gl_version }}.buildinfo .config

          cat >> .config <<EOF
          CONFIG_PACKAGE_kmod-amneziawg=m
          CONFIG_PACKAGE_amneziawg-tools=m
          CONFIG_PACKAGE_luci-proto-amneziawg=m
          EOF

          make defconfig

          # Override vermagic
          sed -i.bak '/\.vermagic/c\	echo "${{ env.gl_vermagic }}" > $(LINUX_DIR)/.vermagic' ./include/kernel-defaults.mk

      # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÐºÑÑˆÐ°
      - name: Check build cache status
        run: |
          cd owrt
          echo "ðŸ“Š Build cache status:"
          echo "â€¢ Downloads: $(du -sh dl 2>/dev/null || echo '0B')"
          echo "â€¢ Feeds: $(du -sh feeds 2>/dev/null || echo '0B')"
          echo "â€¢ Staging: $(du -sh staging_dir 2>/dev/null || echo '0B')"
          echo "â€¢ Toolchain: $(du -sh build_dir/toolchain-* 2>/dev/null || echo '0B')"
          echo "â€¢ Build artifacts: $(du -sh build_dir/target-* 2>/dev/null || echo '0B')"

      - name: Build Kernel and Toolchain
        run: |
          cd owrt
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑƒÐ¶Ðµ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ toolchain
          if [ -f "staging_dir/toolchain-*/bin/mips-openwrt-linux-musl-gcc" ] || \
             [ -f "staging_dir/toolchain-*/bin/aarch64-openwrt-linux-musl-gcc" ] || \
             [ -f "staging_dir/toolchain-*/bin/arm-openwrt-linux-muslgnueabi-gcc" ]; then
            echo "âœ… Using cached toolchain"
          else
            echo "ðŸ”§ Building toolchain (cache miss)"
            make tools/install -j$(nproc)
            make toolchain/install -j$(nproc)
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ ÑÐ´Ñ€Ð°
          if [ -d "build_dir/target-*/linux-*" ] && [ -f "build_dir/target-*/linux-*/.vermagic" ]; then
            echo "âœ… Using cached kernel build"
          else
            echo "ðŸ”§ Building kernel (cache miss)"
            make target/linux/{clean,compile} -i -j$(nproc) V=s
          fi

      - name: Build AmneziaWG Packages
        run: |
          cd owrt
          success=0
          total=0
          
          # Ð¤Ð¾Ñ€ÑÐ¸Ñ€ÑƒÐµÐ¼ Ð¿ÐµÑ€ÐµÑÐ±Ð¾Ñ€ÐºÑƒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ AmneziaWG Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            echo "ðŸ”„ Force rebuild requested"
            make package/awg/{clean,download,prepare} V=s || true
          fi
          
          for pkg in package/awg/*/; do
            [ -f "$pkg/Makefile" ] || continue
            pkgname=$(basename "$pkg")
            echo "ðŸ”§ Building: $pkgname"
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑƒÐ¶Ðµ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ð°ÐºÐµÑ‚
            if find bin/ -name "$pkgname*.ipk" -newer "$pkg/Makefile" 2>/dev/null | grep -q .; then
              echo "âœ… Using cached package: $pkgname"
              success=$((success+1))
            else
              echo "ðŸ”§ Building package: $pkgname (cache miss or outdated)"
              make package/awg/${pkgname}/clean V=s || true
              make package/awg/${pkgname}/download V=s || true
              make package/awg/${pkgname}/prepare V=s || true
              if make package/awg/${pkgname}/compile V=s; then
                success=$((success+1))
              fi
            fi
            total=$((total+1))
          done
          
          echo "âœ… $success/$total packages built/cached."
          [ "$success" -gt 0 ] || exit 1

      - name: Collect Built Packages
        run: |
          cd owrt
          mkdir -p ../artifacts
          packages_found=0
          
          for pattern in kmod-amneziawg amneziawg-tools luci-proto-amneziawg; do
            files=$(find bin/ -name "${pattern}*.ipk" 2>/dev/null || true)
            if [ -n "$files" ]; then
              echo "$files" | while read -r file; do
                [ -f "$file" ] || continue
                cp "$file" ../artifacts/
                echo "âœ… Copied: $(basename "$file")"
                packages_found=$((packages_found + 1))
              done
            else
              echo "âš ï¸ Pattern $pattern not found"
            fi
          done
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð²
          if [ -z "$(ls -A ../artifacts/ 2>/dev/null)" ]; then
            echo "âŒ No packages found to collect"
            echo "Available packages:"
            find bin/ -name "*.ipk" | head -20
            exit 1
          fi

      - name: Extract kernel info
        id: kinfo
        run: |
          cd owrt
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð°
          for i in {1..30}; do
            VERMAGIC_FILE=$(find build_dir/target-*/linux-*/linux-*/.vermagic 2>/dev/null | head -n1)
            [ -n "$VERMAGIC_FILE" ] && [ -f "$VERMAGIC_FILE" ] && break
            echo "Waiting for .vermagic file... ($i/30)"
            sleep 2
          done
          
          if [ ! -f "$VERMAGIC_FILE" ]; then
            echo "âŒ .vermagic not found after 60s timeout"
            find build_dir/ -name ".vermagic" -ls 2>/dev/null || true
            exit 1
          fi

          # Ð¡Ñ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ VERMAGIC
          echo "vermagic=$(cat "$VERMAGIC_FILE")" >> "$GITHUB_OUTPUT"

          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ ÑÐ´Ñ€Ð°
          KERNEL_DIR=$(dirname "$VERMAGIC_FILE")
          KERNEL_VERSION=$(make -s -C "$KERNEL_DIR" kernelversion 2>/dev/null || echo "unknown")
          echo "kernel_version=$KERNEL_VERSION" >> "$GITHUB_OUTPUT"

      - name: Create release notes
        run: |
          cat > release_notes.md <<EOF
          # AmneziaWG GL.iNet v${{ env.gl_version }}
          
          Built from OpenWRT ${{ env.owr_branch }} (commit: ${{ env.owr_commit }})
          
          ## Kernel Information
          â€¢ **Version**: ${{ steps.kinfo.outputs.kernel_version }}
          â€¢ **VERMAGIC**: ${{ steps.kinfo.outputs.vermagic }}
          
          ## Package Contents
          EOF
          
          if [ -d artifacts ] && [ "$(ls -A artifacts/)" ]; then
            for f in artifacts/*.ipk; do
              [ -f "$f" ] || continue
              name=$(basename "$f")
              size=$(stat -c%s "$f" 2>/dev/null || echo "unknown")
              echo "â€¢ \`$name\` ($size bytes)" >> release_notes.md
            done
          else
            echo "âš ï¸ No packages found in artifacts/" >> release_notes.md
          fi

      - name: Upload Packages as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: amneziawg-packages-${{ env.gl_version }}
          path: artifacts/*.ipk

      - name: Auto-Publish Release
        if: startsWith(github.ref, 'refs/tags/') && hashFiles('artifacts/*.ipk') != ''
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.ipk
          body_path: release_notes.md
          fail_on_unmatched_files: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ ÐºÑÑˆÐ° Ð² ÐºÐ¾Ð½Ñ†Ðµ
      - name: Cache statistics
        if: always()
        run: |
          echo "ðŸ“Š Final cache statistics:"
          echo "â€¢ Total downloads: $(du -sh owrt/dl 2>/dev/null || echo '0B')"
          echo "â€¢ Feeds size: $(du -sh owrt/feeds 2>/dev/null || echo '0B')"
          echo "â€¢ Staging dir: $(du -sh owrt/staging_dir 2>/dev/null || echo '0B')"
          echo "â€¢ Build artifacts: $(du -sh owrt/build_dir 2>/dev/null || echo '0B')"
          echo "â€¢ Artifacts created: $(ls -la artifacts/ 2>/dev/null | wc -l) files"
